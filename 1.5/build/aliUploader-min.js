/*!build time : 2013-10-17 4:35:43 PM*/
KISSY.add("gallery/uploader/1.5/type/base",function(a,b,c){function d(a){var b=this;d.superclass.constructor.call(b,a)}var e="";return b.all,a.mix(d,{event:{START:"start",STOP:"stop",SUCCESS:"success",ERROR:"error"}}),a.extend(d,c,{upload:function(){},stop:function(){},_processResponse:function(b){var c=this,d=c.get("filter"),f={};if(d!=e&&(b=d.call(c,b)),a.isString(b))try{f=a.JSON.parse(b),f=c._fromUnicode(f)}catch(g){var h=b+"\uff0c\u8fd4\u56de\u7ed3\u679c\u96c6responseText\u683c\u5f0f\u4e0d\u5408\u6cd5\uff01";a.log(h),c.fire("error",{status:-1,result:{msg:h}})}else a.isObject(b)&&(f=c._fromUnicode(b));return a.log("\u670d\u52a1\u5668\u7aef\u8f93\u51fa\uff1a"+a.JSON.stringify(f)),f},_fromUnicode:function(b){function c(b){a.each(b,function(d,e){a.isObject(b[e])?c(b[e]):b[e]=a.isString(d)&&a.fromUnicode(d)||d})}return a.isObject(b)?(c(b),b):b}},{ATTRS:{action:{value:e},data:{value:{}},filter:{value:e}}}),d},{requires:["node","base"]}),KISSY.add("gallery/uploader/1.5/type/iframe",function(a,b,c){function d(a){var b=this;d.superclass.constructor.call(b,a)}var e="",f=b.all,g="[uploader-iframeType]:",h="ks-uploader-iframe-";return a.mix(d,{tpl:{IFRAME:'<iframe src="javascript:false;" name="{id}" id="{id}" border="no" width="1" height="1" style="display: none;" />',FORM:'<form method="post" enctype="multipart/form-data" action="{action}" target="{target}" style="visibility: hidden;">{hiddenInputs}</form>',HIDDEN_INPUT:'<input type="hidden" name="{name}" value="{value}" />'},event:a.mix(c.event,{CREATE:"create",REMOVE:"remove"})}),a.extend(d,c,{upload:function(b){var c,e=this,h=f(b);return h.length?(e.fire(d.event.START,{input:h}),e.set("fileInput",h),e._create(),(c=e.get("form"))?(c.getDOMNode().submit(),void 0):(a.log(g+"form\u8282\u70b9\u4e0d\u5b58\u5728\uff01"),!1)):!1},stop:function(){var a=this,b=a.get("iframe");return b.attr("src",'javascript:"<html></html>";'),a._remove(),a.fire(d.event.STOP),a.fire(d.event.ERROR,{status:"abort",msg:"\u4e0a\u4f20\u5931\u8d25\uff0c\u539f\u56e0\uff1aabort"}),a},dataToHidden:function(b){if(!a.isObject(b)||a.isEmptyObject(b))return"";var c=this,d=e,f=c.get("tpl"),g=f.HIDDEN_INPUT;if(!a.isString(g))return"";for(var h in b)d+=a.substitute(g,{name:h,value:b[h]});return d},_createIframe:function(){var b,c,d=this,e=h+a.guid(),i=d.get("tpl"),j=i.IFRAME,k=d.get("iframe");return a.isEmptyObject(k)?a.isString(j)?a.isString(e)?(b=a.substitute(i.IFRAME,{id:e}),c=f(b),c.on("load",d._iframeLoadHandler,d),f("body").append(c),d.set("id",e),d.set("iframe",c),c):(a.log(g+"id\u5fc5\u987b\u5b58\u5728\u4e14\u4e3a\u5b57\u7b26\u4e32\u7c7b\u578b\uff01"),!1):(a.log(g+"iframe\u7684\u6a21\u677f\u4e0d\u5408\u6cd5\uff01"),!1):k},_iframeLoadHandler:function(a){var b,c=this,f=a.target,g=d.event.ERROR,h=f.contentDocument||window.frames[f.id].document;if(!h||!h.body)return c.fire(g,{msg:"\u670d\u52a1\u5668\u7aef\u8fd4\u56de\u6570\u636e\u6709\u95ee\u9898\uff01"}),!1;var i=h.body.innerHTML;return i==e?!1:(b=c._processResponse(i),c.fire(d.event.SUCCESS,{result:b}),c._remove(),void 0)},_createForm:function(){var b,c,d,e=this,h=e.get("id"),i=e.get("tpl"),j=i.FORM,k=e.get("data"),l=e.get("action"),m=e.get("fileInput");return a.isString(j)?a.isString(l)?(b=e.dataToHidden(k),b+=e.dataToHidden({type:"iframe"}),d=a.substitute(j,{action:l,target:h,hiddenInputs:b}),c=f(d).append(m),f("body").append(c),e.set("form",c),c):(a.log(g+"action\u53c2\u6570\u4e0d\u5408\u6cd5\uff01"),!1):(a.log(g+"form\u6a21\u677f\u4e0d\u5408\u6cd5\uff01"),!1)},_create:function(){var a=this,b=a._createIframe(),c=a._createForm();a.fire(d.event.CREATE,{iframe:b,form:c})},_remove:function(){var a=this,b=a.get("form");return b?(b.remove(),a.reset("form"),a.fire(d.event.REMOVE,{form:b}),void 0):!1}},{ATTRS:{tpl:{value:d.tpl},id:{value:h+a.guid()},iframe:{value:{}},form:{value:e},fileInput:{value:e}}}),d},{requires:["node","./base"]}),KISSY.add("gallery/uploader/1.5/type/ajax",function(a,b,c,d){function e(a){var b=this;e.superclass.constructor.call(b,a),b._setWithCredentials()}var f="",g=b.all,h="[uploader-AjaxType]:";return a.mix(e,{event:a.merge(c.event,{PROGRESS:"progress"})}),a.extend(e,c,{upload:function(b){var c=this;if(!b)return a.log(h+"upload()\uff0cfileData\u53c2\u6570\u6709\u8bef\uff01"),c;var d=c.get("blobSize");return d>0?c._chunkedUpload(b):c._fullUpload(b),c},stop:function(){var b=this,c=b.get("ajax");return a.isObject(c)?(c.abort(),b.fire(e.event.STOP),b):(a.log(h+"stop()\uff0cio\u503c\u9519\u8bef\uff01"),b)},_getFormData:function(b){return g.isArray(b)?b:a.isObject(b)?(b=[],g.each(b,function(a,c){b.push({name:a,value:c})}),b):b},_setWithCredentials:function(){var b=this;b.get("CORS");var c=b.get("ajaxConfig");return a.mix(c,{xhrFields:{withCredentials:!0}}),c},_setFormData:function(){var b=this;try{b.set("formData",new FormData),b._processData()}catch(c){a.log(h+"something error when reset FormData.")}},_resetFormData:function(){var a=this;a.set("formData",new FormData)},_processData:function(){var b=this,c=b.get("data"),d=b.get("formData");a.each(c,function(a,b){d.append(b,a)}),b.set("formData",d)},_addFileData:function(b){if(!a.isObject(b))return a.log(h+"_addFileData()\uff0cfile\u53c2\u6570\u6709\u8bef\uff01"),!1;var c=this,d=c.get("formData"),e=c.get("fileDataName"),f=b.name;return d.append(e,b,f),c.set("formData",d),d},_chunkedUpload:function(b){function c(){var h=l.call(b,j,j+k,b.type),m=h.size;f._setContentDisposition(b.name),f._setContentRange(j,m,i),f._setFormData(),f._addFileData(h),a.mix(g,{data:f.get("formData")});var n=d(g);n.then(function(a){var b=a[0];j=f._getUploadedBytes(n)||j+m,f.fire(e.event.PROGRESS,{loaded:j,total:i}),i>j?c():f.fire(e.event.SUCCESS,{result:b})},function(a){f._errorHandler(a,b)})}if(!a.isObject(b))return!1;var f=this,g=f.get("ajaxConfig"),h=f.get("action");a.mix(g,{url:h});var i=b.size,j=0,k=f.get("blobSize")||i,l=b.slice||b.webkitSlice||b.mozSlice;c()},_fullUpload:function(b){var c=this,f=c.get("ajaxConfig");c._setFormData(),c._addFileData(b),a.mix(f,{data:c.get("formData"),url:c.get("action")});var g=d(f);return g.then(function(a){var b=a[0];c.fire(e.event.SUCCESS,{result:b})},function(a){c._errorHandler(a,b)}),c.set("ajax",g),g},_errorHandler:function(a,b){var c=this,d={},f=a[1];"timeout"==f&&(d.msg="\u8bf7\u6c42\u8d85\u65f6\uff01",d.status="timeout"),c.fire(e.event.ERROR,{status:f,result:d,file:b})},_getUploadedBytes:function(a){var b=a.getResponseHeader("Range"),c=b&&b.split("-"),d=c&&c.length>1&&parseInt(c[1],10);return d&&d+1},_setContentRange:function(a,b,c){var d="bytes "+a+"-"+(a+b-1)+"/"+c,e=this,f=e.get("ajaxConfig"),g=f.headers;return g["Content-Range"]=d,d},_setContentDisposition:function(a){return this._setRequestHeader("Content-Disposition",'attachment; filename="'+encodeURI(a)+'"')},_setRequestHeader:function(a,b){var c=this,d=c.get("ajaxConfig");return d.headers[a]=b,c.set("ajaxConfig",d),b}},{ATTRS:{formData:{value:f},ajaxConfig:{value:{type:"post",processData:!1,cache:!1,dataType:"json",contentType:!1,timeout:10,headers:{}}},ajax:{value:f},fileDataName:{value:f},form:{value:{}},fileInput:{value:f},blobSize:{value:0},CORS:{value:!1},isUsePostMessage:{value:!1}}}),e},{requires:["node","./base","ajax"]}),KISSY.add("gallery/uploader/1.5/type/flash",function(a,b,c){function d(a){var b=this;d.superclass.constructor.call(b,a),b.isHasCrossdomain(),b._init()}var e="",f="[uploader-FlashType]:";return a.mix(d,{event:a.merge(c.event,{SWF_READY:"swfReady",PROGRESS:"progress"})}),a.extend(d,c,{_init:function(){var b=this,c=b.get("swfUploader");return c?(c.on("contentReady",function(){b.fire(d.event.SWF_READY)},b),c.on("uploadStart",b._uploadStartHandler,b),c.on("uploadProgress",b._uploadProgressHandler,b),c.on("uploadCompleteData",b._uploadCompleteDataHandler,b),c.on("uploadError",b._uploadErrorHandler,b),void 0):(a.log(f+"swfUploader\u5bf9\u8c61\u4e3a\u7a7a\uff01"),!1)},upload:function(b){var c=this,d=c.get("swfUploader"),e=c.get("action"),f="POST",g=c.get("data"),h=c.get("fileDataName");return h||(h="Filedata"),c.set("uploadingId",b),a.mix(g,{type:"flash"}),d.upload(b,e,f,g,h),c},stop:function(){var a=this,b=a.get("swfUploader"),c=a.get("uploadingId");return c!=e&&(b.cancel(c),a.fire(d.event.STOP,{id:c})),a},_uploadStartHandler:function(a){var b=this;b.fire(d.event.START,{file:a.file})},_uploadProgressHandler:function(b){var c=this;a.mix(b,{loaded:b.bytesLoaded,total:b.bytesTotal}),a.log(f+"\u5df2\u7ecf\u4e0a\u4f20\u5b57\u8282\u6570\u4e3a\uff1a"+b.bytesLoaded),c.fire(d.event.PROGRESS,{loaded:b.loaded,total:b.total})},_uploadCompleteDataHandler:function(a){var b=this,c=b._processResponse(a.data);b.set("uploadingId",e),b.fire(d.event.SUCCESS,{result:c})},_uploadErrorHandler:function(a){var b=this;b.set("uploadingId",e),b.fire(d.event.ERROR,{msg:a.msg})},isHasCrossdomain:function(){var b=location.hostname;a.io({url:"http://"+b+"/crossdomain.xml",dataType:"xml",error:function(){a.log("\u7f3a\u5c11crossdomain.xml\u6587\u4ef6\u6216\u8be5\u6587\u4ef6\u4e0d\u5408\u6cd5\uff01")}})}},{ATTRS:{action:{value:e,getter:function(b){var c=/^http/;if(!c.test(b)){var d,e=location.href,f=e.split("/");d=a.filter(f,function(a,b){return b<f.length-1}),b=d.join("/")+"/"+b}return b}},swfUploader:{value:e},uploadingId:{value:e}}}),d},{requires:["node","./base"]}),KISSY.add("gallery/uploader/1.5/button/base",function(a,b,c){function d(b,c){var e=this;c=a.merge({target:g(b)},c),d.superclass.constructor.call(e,c)}var e="",f="[Uploader-Button] ",g=b.all;return a.mix(d,{event:{beforeShow:"beforeShow",afterShow:"afterShow",beforeHide:"beforeHide",afterHide:"afterHide",beforeRender:"beforeRender",afterRender:"afterRender",CHANGE:"change"},getFileName:function(a){return a.replace(/.*(\/|\\)/,"")}}),a.extend(d,c,{render:function(){var b=this,c=b.get("srcFileInput");if(!c||!c.length)return a.log("[Button]file\u5143\u7d20\u4e0d\u5b58\u5728\uff01"),b;var d=c.clone();d.addClass("file-input"),c.remove(),b.set("srcFileInput",d),b._createInput()},show:function(){var a=this,b=a.get("target");return b.show(),a.fire(d.event.afterShow),d},hide:function(){var a=this,b=a.get("target");return b.hide(),a.fire(d.event.afterHide),d},reset:function(){var a=this,b=a.get("inputContainer");return g(b).remove(),a.set("inputContainer",e),a.set("fileInput",e),a._createInput(),a},_createInput:function(){var b=this,c=b.get("target");b.get("name");var d=b.get("tpl");if(!a.isString(d))return!1;var e=b.get("srcFileInput");if(!e.length)return!1;var f=e.clone();b.set("fileInput",f);var h=g(d);return h.append(f),h.appendTo(c),6==a.UA.ie&&f.css("fontSize","400px"),g(f).on("change",b._changeHandler,b),b.set("inputContainer",h),b._setDisabled(b.get("disabled")),b._setMultiple(b.get("multiple")),h},_changeHandler:function(b){var c=this,h=c.get("fileInput"),i=g(h).val(),j=b.target.files,k=[];return i==e?(a.log(f+"No file selected."),!1):(j?a.each(j,function(b){a.isObject(b)&&k.push({name:b.name,type:b.type,size:b.size,data:b})}):k.push({name:d.getFileName(i)}),c.fire(d.event.CHANGE,{files:k,input:h.getDOMNode()}),c.reset(),void 0)},_setDisabled:function(b){var c=this,d=c.get("cls"),e=d.disabled,f=c.get("target"),h=c.get("fileInput");return f.length&&a.isBoolean(b)?(b?(f.addClass(e),g(h).hide()):(f.removeClass(e),g(h).show()),b):!1},_setMultiple:function(a){var b=this,c=b.get("fileInput");return c.length?(a&&c.attr("multiple","multiple")||c.removeAttr("multiple"),a):!1}},{ATTRS:{target:{value:null},fileInput:{value:e},srcFileInput:{value:e},inputContainer:{value:e},tpl:{value:'<div class="file-input-wrapper" style="overflow: hidden;"></div>'},name:{value:"fileInput",setter:function(a){return this.get("fileInput")&&g(this.get("fileInput")).attr("name",a),a}},disabled:{value:!1,setter:function(a){return this._setDisabled(a),a}},multiple:{value:!0,setter:function(a){return this._setMultiple(a),a}},cls:{value:{disabled:"uploader-button-disabled"}}}}),d},{requires:["node","base"]}),KISSY.add("gallery/uploader/1.5/plugins/ajbridge/ajbridge",function(a,b){function c(e,i,j){e=e.replace(d,""),i=b._normalize(i||{});var k=this,l=d+e,m=function(b){return b.status<1?(k.fire("failed",{data:b}),void 0):(a.mix(k,b),b.dynamic&&i.src||k.activate(),void 0)};i.id=i.id||a.guid(f),c.instances[i.id]=k,i.src&&(i.params.allowscriptaccess="always",i.params.flashvars=a.merge(i.params.flashvars,{jsEntry:h,swfID:i.id})),j?k.__args=[l,i,m]:a.later(b.add,g,!1,b,[l,i,m])}var d="#",e="1.0.15",f="ks-ajb-",g=100,h="KISSY.AJBridge.eventHandler";return a.mix(c,{version:e,instances:{},eventHandler:function(a,b){var d=c.instances[a];d&&d.__eventHandler(a,b)},augment:function(b,c){a.isString(c)&&(c=[c]),a.isArray(c)&&a.each(c,function(c){b.prototype[c]=function(){try{return this.callSWF(c,a.makeArray(arguments))}catch(b){this.fire("error",{message:b})}}})}}),a.augment(c,a.EventTarget,{init:function(){this.__args&&(b.add.apply(b,this.__args),this.__args=null,delete this.__args)},__eventHandler:function(b,c){var d=this,e=c.type;switch(c.id=b,e){case"log":a.log(c.message);break;default:d.fire(e,c)}},callSWF:function(a,b){var c=this;b=b||[];try{if(c.swf[a])return c.swf[a].apply(c.swf,b)}catch(d){var e="";return 0!==b.length&&(e="'"+b.join("','")+"'"),new Function("self","return self.swf."+a+"("+e+");")(c)}}}),c.augment(c,["activate","getReady","getCoreVersion"]),window.AJBridge=a.AJBridge=c,c},{requires:["gallery/flash/1.0/index"]}),KISSY.add("gallery/uploader/1.5/plugins/ajbridge/uploader",function(a,b,c){function d(b,c){c=c||{};var e={};a.each(["ds","dsp","btn","hand"],function(a){a in c&&(e[a]=c[a])}),c.params=c.params||{},c.params.flashvars=a.merge(c.params.flashvars,e),d.superclass.constructor.call(this,b,c)}return a.extend(d,c),c.augment(d,["setFileFilters","filter","setAllowMultipleFiles","multifile","browse","upload","uploadAll","cancel","getFile","removeFile","lock","unlock","setBtnMode","useHand","clear"]),d.version="1.0.1",c.Uploader=d,c.Uploader},{requires:["gallery/flash/1.0/index","./ajbridge"]}),KISSY.add("gallery/uploader/1.5/button/swfButton",function(a,b,c,d){function e(b,c){var d=this;c=a.merge({target:g(b)},c),e.superclass.constructor.call(d,c)}var f="",g=b.all,h="swf-uploader-wrapper-";return a.mix(e,{event:{RENDER:"render",CHANGE:"change",MOUSE_OVER:"mouseOver",MOUSE_DOWN:"mouseDown",MOUSE_UP:"mouseUp",MOUSE_OUT:"mouseOut",CLICK:"click"}}),a.extend(e,c,{render:function(){var a,b=this,c=b.get("target"),d=b.get("multiple"),f=b.get("fileFilters");c.css("position","relative"),b.set("swfWrapper",b._createSwfWrapper()),b._setFlashSizeConfig(),a=b._initSwfUploader(),a.on("contentReady",function(){a.isContent||(a.isContent=!0,a.browse(d,f),b._bindBtnEvent(),a.on("fileSelect",b._changeHandler,b),b._setDisabled(b.get("disabled")),b.fire(e.event.RENDER))},b);var g=b.get("srcFileInput");return g&&g.length&&g.remove(),b},_createSwfWrapper:function(){var b=this,c=b.get("target"),d=b.get("tpl"),e=b.get("swfWrapperId")!=f&&b.get("swfWrapperId")||h+a.guid(),i=a.substitute(d,{id:e});return b.set("swfWrapperId",e),g(i).appendTo(c)},_initSwfUploader:function(){var b,c=this,e=c.get("flash"),f=c.get("swfWrapperId");a.mix(e,{id:"swfUploader"+a.guid()});try{b=new d(f,e),c.set("swfUploader",b)}catch(g){}return b},_bindBtnEvent:function(){var b=this,c=e.event,d=b.get("swfUploader");return d?(a.each(c,function(a){d.on(a,function(){b.fire(a)},b)}),b):!1},_setFlashSizeConfig:function(){var b=this,c=b.get("flash"),d=(b.get("target"),b.get("size"));a.isEmptyObject(d)||a.mix(c.attrs,d),b.set("flash",c)},_changeHandler:function(a){var b=this;if(b.get("swfUploader").id==a.id){var c=a.fileList;b.fire(e.event.CHANGE,{files:c})}},_setDisabled:function(b){var c=this,d=c.get("swfUploader"),e=c.get("cls"),f=e.disabled,g=c.get("target"),h=c.get("swfWrapper");return d&&a.isBoolean(b)?(b?(g.addClass(f),h.css("top","-3000px")):(g.removeClass(f),h.css("top",0)),b):!1},show:function(){var a=this,b=a.get("target");b.show()},hide:function(){var a=this,b=a.get("target");b.hide()}},{ATTRS:{target:{value:f},swfWrapper:{value:f},swfWrapperId:{value:f},tpl:{value:'<div id="{id}" class="uploader-button-swf" style="position: absolute;top:0;left:0;z-index:2000;"></div>'},multiple:{value:!0,setter:function(a){var b=this,c=b.get("swfUploader");return c&&c.multifile(a),a}},fileFilters:{value:[],setter:function(b){var c=this,d=c.get("swfUploader");return a.isObject(b)&&(b=[b]),d&&a.isArray(b)&&a.later(function(){d.filter(b)},800),b}},disabled:{value:!1,setter:function(a){var b=this,c=b.get("swfUploader");return c&&b._setDisabled(a),a}},cls:{value:{disabled:"uploader-button-disabled"}},size:{value:{}},flash:{value:{src:"http://a.tbcdn.cn/s/kissy/gallery/uploader/1.5/plugins/ajbridge/uploader.swf",id:"swfUploader",params:{bgcolor:"#fff",wmode:"transparent"},attrs:{width:400,height:400},hand:!0,btn:!0}},swfUploader:{value:f},srcFileInput:{value:f}}}),e},{requires:["node","base","../plugins/ajbridge/uploader"]}),KISSY.add("gallery/uploader/1.5/queue",function(a,b,c){function d(a){var b=-1;do a/=1024,b++;while(a>99);return Math.max(a,.1).toFixed(1)+["kB","MB","GB","TB","PB","EB"][b]}function e(a){var b=this;e.superclass.constructor.call(b,a)}var f="",g=(b.all,"[uploader-queue]:");return a.mix(e,{event:{ADD:"add",ADD_FILES:"addFiles",REMOVE:"remove",CLEAR:"clear",FILE_STATUS:"statusChange",UPDATE_FILE:"updateFile"},status:{WAITING:"waiting",START:"start",PROGRESS:"progress",SUCCESS:"success",CANCEL:"cancel",ERROR:"error",RESTORE:"restore"},FILE_ID_PREFIX:"file-"}),a.extend(e,c,{add:function(b,c){var d=this,e={};if(b.length>0){e=[];var f=d.get("uploader"),g=d.get("files").length,h=f.get("max")>0;a.each(b,function(a,b){if(h){var c=f.get("max");c>=g+b+1&&e.push(d._addFile(a))}else e.push(d._addFile(a))})}else e=d._addFile(b);return c&&c.call(d),e},_addFile:function(b,c){if(!a.isObject(b))return a.log(g+"_addFile()\u53c2\u6570file\u4e0d\u5408\u6cd5\uff01"),!1;var d=this,f=d._setAddFileData(b),h=d.getFileIndex(f.id),i=d.get("fnAdd");return a.isFunction(i)&&(f=i(h,f)),d.fire(e.event.ADD,{index:h,file:f,uploader:d.get("uploader")}),c&&c.call(d,h,f),f},remove:function(b,c){var d,f=this,h=f.get("files");return a.isString(b)&&(b=f.getFileIndex(b)),d=h[b],a.isObject(d)?(h=a.filter(h,function(a,c){return c!==b}),f.set("files",h),f.fire(e.event.REMOVE,{index:b,file:d}),c&&c.call(f,b,d),d):(a.log(g+"remove()\u4e0d\u5b58\u5728index\u4e3a"+b+"\u7684\u6587\u4ef6\u6570\u636e"),!1)},clear:function(){function a(){return b=c.get("files"),b.length?(c.remove(0,function(){a()}),void 0):(c.fire(e.event.CLEAR),!1)}var b,c=this;a()},fileStatus:function(b,c,d){if(!a.isNumber(b))return!1;var f,g=this,h=g.getFile(b);return g.get("theme"),h?(f=h.status,c?f==c?g:(g.updateFile(b,{status:c}),g.fire(e.event.FILE_STATUS,{index:b,status:c,args:d,file:h}),g):f):!1},getFile:function(b){var c,d=this,e=d.get("files");return a.isNumber(b)?c=e[b]:a.each(e,function(a){return a.id==b?(c=a,!0):void 0}),c},getFileIndex:function(b){var c=this,d=c.get("files"),e=-1;return a.each(d,function(a,c){return a.id==b?(e=c,!0):void 0}),e},updateFile:function(b,c){if(!a.isNumber(b))return!1;if(!a.isObject(c))return a.log(g+"updateFile()\u7684data\u53c2\u6570\u6709\u8bef\uff01"),!1;var d=this,f=d.get("files"),h=d.getFile(b);return h?(a.mix(h,c),f[b]=h,d.set("files",f),d.fire(e.event.UPDATE_FILE,{index:b,file:h}),h):!1},getIndexs:function(b){var c,d=this,e=d.get("files"),f=[];return e.length?(a.each(e,function(d,e){a.isObject(d)&&(c=d.status,c==b&&f.push(e))}),f):f},getFiles:function(b){var c=this,d=c.get("files"),e=[];return d.length?(a.each(d,function(a){a&&a.status==b&&e.push(a)}),e):[]},_setAddFileData:function(b){var c=this,f=c.get("files");return a.isObject(b)?(b.id||(b.id=a.guid(e.FILE_ID_PREFIX)),b.size&&(b.textSize=d(b.size)),b.status||(b.status="waiting"),f.push(b),b):(a.log(g+"_updateFileData()\u53c2\u6570file\u4e0d\u5408\u6cd5\uff01"),!1)}},{ATTRS:{fnAdd:{value:f},files:{value:[]},uploader:{value:f}}}),e},{requires:["node","base"]}),KISSY.add("gallery/uploader/1.5/base",function(a,b,c,d,e,f,g,h,i,j){function k(a){var b=this;k.superclass.constructor.call(b,a)}var l="",m=(c.all,"[uploader]:");return a.mix(k,{type:{AUTO:"auto",IFRAME:"iframe",AJAX:"ajax",FLASH:"flash"},event:{SELECT:"select",ADD:"add",START:"start",PROGRESS:"progress",COMPLETE:"complete",SUCCESS:"success",UPLOAD_FILES:"uploadFiles",CANCEL:"cancel",ERROR:"error",REMOVE:"remove",RESTORE:"restore"},status:{WAITING:"waiting",START:"start",PROGRESS:"progress",SUCCESS:"success",CANCEL:"cancel",ERROR:"error"}}),a.extend(k,b,{upload:function(b){if(!a.isNumber(b))return!1;var c,d=this,e=d.get("uploadType"),f=d.get("type"),g=d.get("queue"),h=g.get("files")[b];return a.isObject(h)?d.get("curUploadIndex")!=l?(alert("\u7b2c"+d.get("curUploadIndex")+"\u6587\u4ef6\u6b63\u5728\u4e0a\u4f20\uff0c\u8bf7\u4e0a\u4f20\u5b8c\u540e\u518d\u64cd\u4f5c\uff01"),!1):(c=h.input,"flash"==f&&(c=h.input.id),"ajax"==f&&(c=h.data),"error"===h.status?!1:d.get("isAllowUpload")?(d.set("curUploadIndex",b),d.fire(k.event.START,{index:b,file:h}),g.fileStatus(b,k.status.START),e.upload(c),void 0):!1):(a.log(m+"\u961f\u5217\u4e2d\u7d22\u5f15\u503c\u4e3a"+b+"\u7684\u6587\u4ef6"),!1)},cancel:function(b){var c=this,d=c.get("uploadType"),e=c.get("queue"),f=k.status,g=e.fileStatus(b);return a.isNumber(b)&&g!=f.SUCCESS?(d.stop(),e.fileStatus(b,f.CANCEL)):(d.stop(),c._continueUpload()),c},stop:function(){var a=this;return a.set("uploadFilesStatus",l),a.cancel(),a},uploadFiles:function(b){var c=this;return a.isString(b)||(b=k.status.WAITING),c.set("uploadFilesStatus",b),c._uploaderStatusFile(b),c},_uploaderStatusFile:function(a){var b=this,c=b.get("queue"),d=c.getIndexs(a);return d.length?(b.upload(d[0]),b):(b.set("uploadFilesStatus",l),b.fire(k.event.UPLOAD_FILES),!1)},isSupportAjax:function(){var a=!1;try{FormData&&(a=!0)}catch(b){a=!1}return a},isSupportFlash:function(){var b=a.UA.fpv();return a.isArray(b)&&b.length>0},_renderUploaderCore:function(b){var c=this;if(c.get("type"),!b)return!1;var d={action:c.get("action"),data:c.get("data"),dataType:"json"},e=c.get("button");c.get("type")==k.type.FLASH&&a.mix(d,{swfUploader:e.get("swfUploader")}),d.fileDataName=c.get("name"),d.CORS=c.get("CORS");var f=new b(d),g=b.event;return f.on(g.SUCCESS,c._uploadCompleteHanlder,c),f.on(g.ERROR,c._uploadCompleteHanlder,c),g.PROGRESS&&f.on(g.PROGRESS,c._uploadProgressHandler,c),f.on(g.STOP,c._uploadStopHanlder,c),c.set("uploadType",f),f},getUploadType:function(b){var c,d=this,e=k.type;return b==e.AUTO&&(b=[e.AJAX,e.IFRAME]),a.isArray(b)&&b.length>0?a.each(b,function(a){return c=d._getType(a),c?!1:void 0}):c=d._getType(b),c},_getType:function(b){var c,d=this,h=k.type,i=d.isSupportAjax(),j=d.isSupportFlash();switch(b){case h.IFRAME:c=e;break;case h.AJAX:c=i&&f||!1;break;case h.FLASH:c=j&&g||!1;break;default:return a.log(m+"type\u53c2\u6570\u4e0d\u5408\u6cd5"),!1}return c&&a.log(m+"\u4f7f\u7528"+b+"\u4e0a\u4f20\u65b9\u5f0f"),d.set("type",b),c},_renderButton:function(){var b,c,e=this,f=e.get("type"),g=e.get("target"),j=e.get("multiple"),l=e.get("disabled"),m=e.get("name"),n={name:m,multiple:j,disabled:l,srcFileInput:e.get("fileInput")};return f==k.type.FLASH?(c=i,a.mix(n,{size:e.get("swfSize")})):c=h,b=new c(g,n),b.on("change",e._select,e),b.render(),e.set("button",b),f==k.type.IFRAME&&d.ie<10&&e.set("multiple",!1),b},_renderQueue:function(){var a=this,b=new j;return b.set("uploader",a),b.on("add",function(b){a.fire(k.event.ADD,b)}),b.on("remove",function(b){a.fire(k.event.REMOVE,b)}),a.set("queue",b),b},_select:function(b){var c=this,d=c.get("autoUpload"),e=c.get("queue"),f=c.get("curUploadIndex"),g=b.files;return a.each(g,function(a){a.size||(a.size=0),a.name||(a.name=a.fileName||l),a.input=b.input||a}),g=c._processExceedMultiple(g),c.fire(k.event.SELECT,{files:g}),c.get("isAllowUpload")?(e.add(g,function(){f==l&&d&&c.uploadFiles()}),void 0):!1},_processExceedMultiple:function(b){var c=this,d=c.get("multipleLen");return 0>d||!a.isArray(b)||!b.length?b:a.filter(b,function(a,b){return d>b})},_uploadCompleteHanlder:function(b){var c,d=this,e=b.result,f=k.event,g=d.get("queue"),h=d.get("curUploadIndex");if(!a.isObject(e))return!1;if(g.updateFile(h,{result:e}),c=Number(e.status),1===c)g.fileStatus(h,k.status.SUCCESS),d._success(e.data),d.fire(f.SUCCESS,{index:h,file:g.getFile(h),result:e});else{var i=e.msg||e.message||l;e.msg=i,g.fileStatus(h,k.status.ERROR,{msg:i,result:e}),d.fire(f.ERROR,{msg:i,status:c,result:e,index:h,file:g.getFile(h)})}d.set("curUploadIndex",l),d.fire(f.COMPLETE,{index:h,file:g.getFile(h),result:e}),d._continueUpload()},_uploadStopHanlder:function(){var a=this,b=a.get("queue"),c=a.get("curUploadIndex");b.fileStatus(c,k.status.CANCEL),a.set("curUploadIndex",l),a.fire(k.event.CANCEL,{index:c})},_continueUpload:function(){var a=this,b=a.get("uploadFilesStatus");b!=l&&a._uploaderStatusFile(b)},_uploadProgressHandler:function(b){var c=this,d=c.get("queue"),e=c.get("curUploadIndex"),f=d.getFile(e);a.mix(b,{file:f}),d.fileStatus(e,k.status.PROGRESS,b),c.fire(k.event.PROGRESS,b)},_success:function(b){if(!a.isObject(b))return!1;var c=this,d=b.url,e=c.get("curUploadIndex"),f=c.get("queue");return a.isString(d)?(f.updateFile(e,{sUrl:d}),void 0):!1}},{ATTRS:{button:{value:{}},queue:{value:{}},curUploadIndex:{value:l},curFile:{value:l,getter:function(){var b=this,c=l,d=b.get("curUploadIndex");if(a.isNumber(d)){var e=b.get("queue");c=e.getFile(d)}return c}},uploadType:{value:{}},fileInput:{value:l},uploadFilesStatus:{value:l},swfSize:{value:{}},CORS:{value:!1}}}),k},{requires:["base","node","ua","./type/iframe","./type/ajax","./type/flash","./button/base","./button/swfButton","./queue"]}),KISSY.add("gallery/uploader/1.5/index",function(a,b,c,d,e){var f="",g=b.all,h="text/uploader-files",i=d.extend([c],{constructor:function(a,b){var c=this;i.superclass.constructor.call(c,b),c.set("target",a),c._init()},_init:function(){var b=this,c=b.get("target");if(!c.length)return a.log("\u76ee\u6807\u5143\u7d20\u4e0d\u5b58\u5728\uff01"),!1;var d=b.get("type"),e=b.getUploadType(d);return b._replaceBtn(),b._renderButton(),b._renderQueue(),b._renderUploaderCore(e),b},_replaceBtn:function(){var b=this,c=b.get("target");if(!c.length)return!1;var d=c[0].defaultValue||"\u4e0a\u4f20\u6587\u4ef6",e=a.substitute(b.get("btnTpl"),{text:d}),f=g(e).insertAfter(c);return!b.get("name")&&c.attr("name")&&b.set("name",c.attr("name")),b.set("_oldInput",c.clone()),b.set("fileInput",c),b.set("target",f),f},theme:function(b){var c=this,d=c.get("theme");return b?d?(a.log("\u4e0d\u652f\u6301\u91cd\u65b0\u6e32\u67d3\u4e3b\u9898\uff01"),c):(b.set("uploader",c),b.set("queue",c.get("queue")),b.render&&b.render(),c.fire("themeRender",{theme:d,uploader:c}),c.set("theme",b),c):!1},restore:function(b){var c,d=this;if(d.set("hasRestore",!0),b){var f=g(b);if(!f.length)return a.log("restore()\uff1a\u4e0d\u5b58\u5728target\uff01"),!1;c=f.text()}else{var i=d.get("theme");if(!i)return!1;var j=i.get("queueTarget");if(!j||!j.length)return!1;var k=j.all("script");k.each(function(a){a.attr("type")==h&&(c=a.html())})}if(c=e.parse(c),!c.length)return!1;var l,m=d.get("queue");a.each(c,function(a){a.status=1,l={type:"restore",name:a.name||"",url:a.url||"",result:a};var b=m.add(l),c=b.id,e=m.getFileIndex(c);m.fileStatus(e,"success",{index:e,id:c,file:b}),d.fire("success",{file:b,result:b.result})})}},{ATTRS:{target:{value:f,getter:function(a){return g(a)}},fileInput:{value:f},theme:{value:f},btnTpl:{value:'<a href="javascript:void(0)" class="g-u ks-uploader-button"><span class="btn-text">{text}</span></a>'},button:{value:{}},queue:{value:{}},type:{value:"auto"},multiple:{value:!1,setter:function(b){var c=this,d=c.get("button");return!a.isEmptyObject(d)&&a.isBoolean(b)&&d.set("multiple",b),b}},multipleLen:{value:-1},disabled:{value:!1,setter:function(b){var c=this,d=c.get("button");return!a.isEmptyObject(d)&&a.isBoolean(b)&&d.set("disabled",b),b}},action:{value:f,setter:function(a){var b=this,c=b.get("uploadType");return c&&c.set("action",a),a}},data:{value:{},setter:function(b){if(a.isObject(b)){var c=this,d=c.get("uploadType");d&&d.set("data",b)}return b}},isAllowUpload:{value:!0},autoUpload:{value:!0},filter:{value:f,setter:function(a){var b=this,c=b.get("uploadType");return c&&c.set("filter",a),a}},curUploadIndex:{value:f},uploadType:{value:f},swfSize:{value:{}},hasRestore:{value:!1}}},"Uploader");return i},{requires:["node","./base","rich-base","json"]}),KISSY.add("gallery/uploader/1.5/plugins/auth/auth",function(a,b,c){function d(a){var b=-1;do a/=1024,b++;while(a>99);return Math.max(a,.1).toFixed(1)+["kB","MB","GB","TB","PB","EB"][b]}function e(a){var b=this;e.superclass.constructor.call(b,a)}var f="",g=b.all,h="error";return a.extend(e,c,{pluginInitializer:function(a){if(!a)return!1;var b=this;b.set("uploader",a),b._useThemeConfig();var c=a.get("queue");b._setSwfButtonExt(),c.on("add",function(a){var c=a.file;if("restore"==c.type)return!0;var d=b.testAllowExt(c);d&&(d=b.testMaxSize(c)),d&&b.testRepeat(c),d&&b.testWidthHeight(c)}),c.on("remove",function(a){var c=a.file,d=c.status;"success"==d&&b.testMax()&&b.testRequired()}),a.on("success",function(){b.testMax()}),a.on("error",function(c){-1===c.status&&"max"==c.rule&&b._maxStopUpload(),a.set("isAllowUpload",!0)})},_useThemeConfig:function(){var b=this,c=b.get("msg");if(!a.isEmptyObject(c))return!1;var d=b.get("uploader"),e=d.get("theme");if(!e)return!1;var c=e.get("authMsg");c&&b.set("msg",c);var f=b.get("allowExts");return f||b.set("allowExts",e.get("allowExts")),b},setAllowExts:function(b){if(!a.isString(b))return!1;var c=[],d=[];return b=b.split(","),a.each(b,function(a){c.push("*."+a),d.push(a.toUpperCase())}),c=c.join(";"),d=d.join(","),{desc:d,ext:c}},testAll:function(){var a=this;return a.testRequire()&&a.testMax()},isUploaderType:function(a){var b=this,c=b.get("uploader"),d=c.get("type");return a==d},testRequired:function(){var a=this,b=a.get("uploader"),c=b.get("queue"),d=c.getFiles("success");return d.length>0},testAllowExt:function(b){function c(b,c){var d,e=!1,f=c.toLowerCase();return a.each(b,function(a){return d=new RegExp("^.+."+a+"$"),d.test(f)?e=!0:void 0}),e}function d(a){var b=a.split(".");return b[b.length-1]}if(!a.isObject(b))return!1;var e=this,f=b.name,g=e.get("allowExts");if(!g)return!0;var h=g.split(","),i=c(h,f);if(!i){var j=d(f),k=e.msg("allowExts");k=a.substitute(k,{ext:j}),e._fireUploaderError("allowExts",[g,k],b)}return i},testMax:function(){var b=this,c=b.get("max");if(c==f)return!0;var d=b.get("uploader"),e=d.get("queue"),g=e.getFiles("success"),h=g.length,i=c>h;if(i)d.set("disabled",!1),d.set("isAllowUpload",!0);else{d.set("disabled",!0),d.set("isAllowUpload",!1);var j=b.msg("max");j=a.substitute(j,{max:c}),b._fireUploaderError("max",[c,j])}return i},testMaxSize:function(b){var c=this,e=b.size,g=c.get("maxSize");if(g==f||!e)return!0;c.get("uploader"),g=1024*g;var h=g>=e;if(!h){var i=c.msg("maxSize");i=a.substitute(i,{maxSize:d(g),size:b.textSize}),c._fireUploaderError("maxSize",[g,i],b)}return h},testRepeat:function(b){if(!a.isObject(b))return!1;var c=this,d=b.name,e=c.get("allowRepeat");if(e===f)return!1;var g=c.get("uploader"),h=g.get("queue"),i=h.getFiles("success"),j=!1;return a.each(i,function(a){return a.name==d?(a.size?a.size==b.size&&c._fireUploaderError("allowRepeat",[e,c.msg("allowRepeat")],b):c._fireUploaderError("allowRepeat",[e,c.msg("allowRepeat")],b),j=!0):void 0}),j},testWidthHeight:function(b){function c(a,c){var f=e.call(d,a,c);if(f){h.set("isAllowUpload",!0);var g=h.get("queue").getFileIndex(b.id);h.upload(g)}else{var i=d.msg("widthHeight");d._fireUploaderError("widthHeight",[e,i],b)}}var d=this,e=d.get("widthHeight");if(e===f)return!0;var h=d.get("uploader");h.set("isAllowUpload",!1);var i=b.data;if(a.isEmptyObject(i)){var j=h.get("target").all("input").getDOMNode();j.select(),j.blur();var k=document.selection.createRange().text,l=g('<img style="filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod=image);width:300px;visibility:hidden;"  />').appendTo("body").getDOMNode();l.filters.item("DXImageTransform.Microsoft.AlphaImageLoader").src=k;var m=l.offsetWidth,n=l.offsetHeight;c(m,n),g(l).remove()}else{var o=new FileReader;
o.onload=function(a){var b=a.target.result,d=new Image;d.onload=function(){var a=d.width,b=d.height;c(a,b)},d.src=b},o.readAsDataURL(i)}},_setSwfButtonExt:function(){var a=this,b=a.get("uploader"),c=a.get("allowExts"),d=b.get("button"),e=a.isUploaderType("flash");return e&&c!==f?(c=a.setAllowExts(c),d&&d.set("fileFilters",c[0]),a):!1},_getExts:function(b){if(!a.isString(b))return!1;var c=b.split(";"),d=[],e=/^\*\./;return a.each(c,function(a){a=a.replace(e,""),d.push(a.toUpperCase())}),a.each(d,function(a){c.push(a)}),c},_fireUploaderError:function(b,c,d){var e=this,f=e.get("uploader"),g=f.get("queue"),i={status:-1,rule:b},j=-1;d&&(j=g.getFileIndex(d.id),a.mix(i,{file:d,index:j})),c&&a.mix(i,{msg:c[1],value:c[0],result:{}}),g.fileStatus(j,"error",i),e.fire(h,i),f.fire("error",i)},_maxStopUpload:function(){var b=this,c=b.get("uploader"),d=c.get("queue"),e=b.get("max"),g=c.get("curUploadIndex");if(g==f||e>g)return!1;var h=d.get("files");c.stop(),a.each(h,function(a,b){b>=g&&d.remove(a.id)}),c.set("curUploadIndex",f)},msg:function(b,c){var d=this;if(!a.isString(b))return d;var e=d.get("msg");return a.isString(c)?(e[b]=c,c):e[b]},_processRuleConfig:function(b,c){var d=this;return a.isString(b)?(a.isArray(c)&&d.msg(b,c[1]),d):d}},{ATTRS:{pluginId:{value:"auth"},uploader:{value:f},required:{value:f},max:{value:f},allowExts:{value:f},maxSize:{value:f},allowRepeat:{value:f},widthHeight:{value:f},msg:{value:{}}}}),e},{requires:["node","base"]}),KISSY.add("gallery/uploader/1.5/plugins/filedrop/filedrop",function(a,b,c){var d="",e=b.all,f=a.UA,g=function(a){var b=this;g.superclass.constructor.call(b,a),b.set("mode",h())},h=function(){return f.webkit>=7||f.firefox>=3.6?"supportDrop":f.ie?"notSupportDropIe":f.webkit<7||f.firefox<3.6?"notSupportDrop":void 0};return a.mix(g,{event:{AFTER_DROP:"afterdrop"}}),a.extend(g,c,{pluginInitializer:function(b){var c,d=this,e=d.get("mode");if(!b)return!1;if(d.set("uploader",b),"flash"==b.get("type"))return a.log("flash\u4e0a\u4f20\u65b9\u5f0f\u4e0d\u652f\u6301\u62d6\u62fd\uff01"),d.set("isSupport",!1),!1;if("supportDrop"!=e)return a.log("\u8be5\u6d4f\u89c8\u5668\u4e0d\u652f\u6301\u62d6\u62fd\u4e0a\u4f20\uff01"),d.set("isSupport",!1),!1;var f=b.get("target");d.set("target",f),c=d._createDropArea(),c.on("click",d._clickHandler,d),b.on("afterDisabledChange",function(a){d[a.newVal&&"hide"||"show"]()}),d.fire("render",{buttonTarget:d.get("buttonWrap")})},show:function(){var a=this,b=a.get("dropContainer");b.show()},hide:function(){var a=this,b=a.get("dropContainer");b.hide()},_createDropArea:function(){var b=this,c=e(b.get("target")),d=b.get("mode"),f=a.substitute(b.get("tpl")[d],{name:b.get("name")}),g=e(f),h=g.all(".J_ButtonWrap");return g.appendTo(c),g.on("dragover",function(a){a.stopPropagation(),a.preventDefault()}),g.on("drop",function(a){a.stopPropagation(),a.preventDefault(),b._dropHandler(a)}),b.set("dropContainer",g),b.set("buttonWrap",h),b._setStyle(),g},_setStyle:function(){var a=this,b=a.get("dropContainer");return b.length?(b.parent().css("position","relative"),b.css({position:"absolute",top:"0",left:"0",width:"100%",height:"100%",zIndex:"1000"}),void 0):!1},_clickHandler:function(){var a=this,b=a.get("uploader"),c=b.get("button"),d=c.get("fileInput");d.fire("click")},_dropHandler:function(b){var c=this,e=g.event,f=b.originalEvent.dataTransfer.files,h=[],i=c.get("uploader");return f.length&&i!=d?(a.each(f,function(b){a.isObject(b)&&h.push({name:b.name,type:b.type,size:b.size,data:b})}),c.fire(e.AFTER_DROP,{files:h}),i._select({files:h}),void 0):!1}},{ATTRS:{pluginId:{value:"filedrop"},target:{value:d,getter:function(a){return e(a)}},uploader:{value:d},dropContainer:{value:d},isSupport:{value:!0},tpl:{value:{supportDrop:'<div class="drop-wrapper"></div>',notSupportDropIe:'<div class="drop-wrapper"><p>\u60a8\u7684\u6d4f\u89c8\u5668\u53ea\u652f\u6301\u4f20\u7edf\u7684\u56fe\u7247\u4e0a\u4f20\uff0c</p><p class="suggest J_ButtonWrap">\u63a8\u8350\u4f7f\u7528chrome\u6d4f\u89c8\u5668\u6216firefox\u6d4f\u89c8\u5668</p></div>',notSupportDrop:'<div class="drop-wrapper"><p>\u60a8\u7684\u6d4f\u89c8\u5668\u53ea\u652f\u6301\u4f20\u7edf\u7684\u56fe\u7247\u4e0a\u4f20\uff0c</p><p class="suggest J_ButtonWrap">\u63a8\u8350\u5347\u7ea7\u60a8\u7684\u6d4f\u89c8\u5668</p></div>'}},name:{value:""}}}),g},{requires:["node","base"]}),KISSY.add("gallery/uploader/1.5/plugins/imageZoom/imageZoom",function(a,b,c,d){function e(a){var b=this;e.superclass.constructor.call(b,a)}var f="",g=b.all;return a.extend(e,c,{pluginInitializer:function(a){if(!a)return!1;var b=this,c=a.get("theme");if(!c)return!1;var e=b.get("imageHook"),f=new d({baseEl:c.get("queueTarget"),img:e});f.get("baseEl").delegate("click",e,function(a){var b=a.target;f.show(g(b))}),b.set("albums",f),a.on("success",b._successHandler,b)},_successHandler:function(a){var b=a.file,c=b.id,d=b.result,e=d.url,f=g(".J_Pic_"+c);f.attr("data-original-url",e)}},{ATTRS:{pluginId:{value:"imageZoom"},albums:{value:f},imageHook:{value:".preview-img"}}}),e},{requires:["node","base","gallery/albums/1.0/"]}),KISSY.add("gallery/uploader/1.5/plugins/imgcrop/imgcrop",function(a,b,c,d){function e(a){var b=this;e.superclass.constructor.call(b,a),b.set("config",a)}var f=b.all;return a.extend(e,c,{pluginInitializer:function(a){if(!a)return!1;var b=this,c=b.get("config"),e=new d(c);b.set("crop",e),a.on("success",b._successHandler,b),a.on("select",b._selectHandler,b),e.on("imgload",function(){b.set("isRender",!0)})},_successHandler:function(a){var b=this,c=b.get("crop"),d=a.file,e=d.id,g=a.result.url;c.set("url",g);var h=".J_CropArea_"+e,i=f(h);return i.length?(c.set("areaEl",h),c.container=i,c.set("areaWidth",i.width()),c.set("areaHeight",i.height()),c.render(),void 0):!1},_selectHandler:function(){var a=this,b=a.get("isRender"),c=a.get("crop");return b?(c.destroy(),void 0):!1}},{ATTRS:{pluginId:{value:"imgcrop"},isRender:{value:!1},config:{value:{}}}}),e},{requires:["node","base","gallery/imgcrop/2.1/index"]}),KISSY.add("gallery/uploader/1.5/plugins/preview/preview",function(a,b,c,d,e,f){function g(){var b="";if("undefined"==typeof window.FileReader)switch(a.UA.shell){case"firefox":b="domfile";break;case"ie":switch(a.UA.ie){case 6:b="simple";break;default:b="filter"}}else b="html5";return b}function h(a,b){if(!a)return!1;if("filter"!=m)a.src=b||o;else if(b){b=b.replace(/[)'"%]/g,function(a){return escape(escape(a))});try{a.filters.item("DXImageTransform.Microsoft.AlphaImageLoader").src=b}catch(c){}}return!0}function i(b){var c=this,d={maxWidth:40,maxHeight:40};c.config=a.mix(d,b),i.superclass.constructor.call(c,b)}var j=b.all,k=document,l="[Plugin: Preview] ",m=g(),n={check:"check",success:"success",showed:"showed",error:"error"},o=f.ie<8?"http://a.tbcdn.cn/p/fp/2011a/assets/space.gif":"data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==";return a.extend(i,e,{pluginInitializer:function(a){if(!a)return!1;var b=this;b.set("uploader",a),a.on("add",b._uploaderAddHandler,b)},_uploaderAddHandler:function(b){var c=this,d=c.get("uploader");if(d.get("hasRestore"))return!1;var e=d.get("fileInput"),f=b.file,g=f.data,h=f.id,i=c.get("preHook"),k=j(i+h);return k.length?(d.get("multiple")&&"ajax"==d.get("type")?c.show(g,k,function(){k.show()}):(c.preview(e,k),k.show()),void 0):(a.log("\u94a9\u5b50\u4e3a\uff1a"+i+h+"\uff0c\u627e\u4e0d\u5230\u56fe\u7247\u5143\u7d20\uff0c\u65e0\u6cd5\u9884\u89c8\u56fe\u7247"),!1)},show:function(b,c,d){if(!b||!c||!c.length)return!1;var e=this,f=new FileReader;f.onload=function(a){var b=e.data=a.target.result;e.fire(n.getData,{data:b,mode:m}),c.attr("src",b),d&&d.call(e,b),e.fire(n.showed,{img:b})},f.onerror=function(){a.log(l+"File Reader Error. Your browser may not fully support html5 file api","warning"),e.fire(n.error)},f.readAsDataURL(b)},preview:function(b,d){b=c.get(b),d=c.get(d);var e=this,g=function(){e.fire(n.getData,{data:e.data,mode:m}),d&&(h(d,e.data),e.fire(n.showed,{img:d}))};if(e.data=void 0,b){switch(10==f.ie&&(m="filter"),m){case"domfile":e.data=b.files[0].getAsDataURL();break;case"filter":b.select();try{e.data=k.selection.createRange().text}catch(i){a.log(l+"IE\u4e0b\u56e0\u4e3a\u5b89\u5168\u95ee\u9898\u4f1a\u629b\u51fa\u62d2\u7edd\u8bbf\u95ee\u7684\u9519\u8bef\uff0c\u4e0d\u59a8\u788d\u9884\u89c8: "),a.log(i,"dir")}finally{k.selection.empty()}e.data||(e.data=b.value);break;case"html5":var j=new FileReader;j.onload=function(a){e.data=a.target.result,g()},j.onerror=function(){a.log(l+"File Reader Error. Your browser may not fully support html5 file api","warning"),e.fire(n.error)},b.files&&j.readAsDataURL(b.files[0]);break;case"simple":default:e.data=b.value}e.data?g():"html5"!=m&&(h(d),e.fire(n.error))}else a.log(l+"File Input Element does not exists.");return e.data}},{ATTRS:{pluginId:{value:"preview"},uploader:{value:""},preHook:{value:".J_Pic_"}}}),i},{requires:["node","dom","event","base","ua"]}),KISSY.add("gallery/uploader/1.5/plugins/proBars/progressBar",function(a,b,c){function d(b,c){var e=this;c=a.merge({wrapper:f(b)},c),d.superclass.constructor.call(e,c)}var e="",f=b.all,g="progressbar",h="role",i="aria-valuemin",j="aria-valuemax",k="aria-valuenow",l="data-value";return a.mix(d,{tpl:{DEFAULT:'<div class="ks-progress-bar-value" data-value="{value}"></div>'},cls:{PROGRESS_BAR:"ks-progress-bar",VALUE:"ks-progress-bar-value"},event:{RENDER:"render",CHANGE:"change",SHOW:"show",HIDE:"hide"}}),a.extend(d,c,{render:function(){var a=this,b=a.get("wrapper"),c=a.get("width");return b.length?("auto"==c&&(c=b.parent().width()),b.width(c),b.addClass(d.cls.PROGRESS_BAR),a._addAttr(),!a.get("visible")&&a.hide(),a.set("bar",a._create()),a.fire(d.event.RENDER),void 0):!1},show:function(){var a=this,b=a.get("wrapper");b.fadeIn(a.get("duration"),function(){a.set("visible",!0),a.fire(d.event.SHOW,{visible:!0})})},hide:function(){var a=this,b=a.get("wrapper");b.fadeOut(a.get("duration"),function(){a.set("visible",!1),a.fire(d.event.HIDE,{visible:!1})})},_create:function(){var b=this,c=b.get("wrapper"),d=b.get("value"),e=b.get("tpl"),g=a.substitute(e,{value:d});return c.html(""),f(g).appendTo(c)},_addAttr:function(){var a=this,b=a.get("wrapper"),c=a.get("value");return b.attr(h,g),b.attr(i,0),b.attr(j,100),b.attr(k,c),a}},{ATTRS:{wrapper:{value:e},bar:{value:e},width:{value:"auto"},value:{value:0,setter:function(a){var b,c=this,e=c.get("wrapper"),f=c.get("bar"),g=c.get("speed");return a>100&&(a=100),0>a&&(a=0),b=Math.ceil(e.width()*(a/100)),f.stop().animate({width:b+"px"},g,"none",function(){e.attr(k,a),f.attr(l,a),c.fire(d.event.CHANGE,{value:a,width:b})}),a}},visible:{value:!0},duration:{value:.3},tpl:{value:d.tpl.DEFAULT},speed:{value:.2}}}),d},{requires:["node","base"]}),KISSY.add("gallery/uploader/1.5/plugins/proBars/proBars",function(a,b,c,d){function e(a){var b=this;e.superclass.constructor.call(b,a)}var f=b.all,g="J_ProgressBar_";return a.mix(e,{event:{RENDER:"render"}}),a.extend(e,c,{pluginInitializer:function(a){if(!a)return!1;var b=this;a.on("start",function(a){b.add(a.file.id)}),a.on("progress",b._uploaderProgressHandler,b),a.on("success",b._uploaderSuccessHandler,b),b.fire(e.event.RENDER)},_uploaderProgressHandler:function(a){var b=this,c=a.file,d=c.id,e=a.loaded,f=a.total,g=Math.ceil(100*(e/f)),h=b.get("bars")[d];h&&h.set("value",g)},_uploaderSuccessHandler:function(b){var c=this,d=b.file,e=d.id,h=c.get("bars")[e],i=c.get("isHide");h&&h.set("value",100),i&&a.later(function(){var a=f("."+g+b.file.id);a.hide()},500)},add:function(b){if(!a.isString(b))return!1;var c=this,e=f("."+g+b),h=f(".J_ProgressCount_"+b),i=c.get("speed"),j=new d(e,{width:c.get("width"),speed:i});h.length&&j.on("change",function(a){h.text(a.value+"%")}),j.render();var k=c.get("bars");return k[b]=j}},{ATTRS:{pluginId:{value:"proBars"},bars:{value:{}},width:{value:"auto"},isHide:{value:!0},speed:{value:.2}}}),e},{requires:["node","base","./progressBar"]}),KISSY.add("gallery/uploader/1.5/plugins/tagConfig/tagConfig",function(a,b,c){function d(a){var b=this;d.superclass.constructor.call(b,a)}var e="";b.all;var f=["autoUpload","postData","action","multiple","multipleLen","uploadType","disabled"],g=["max","maxSize","allowRepeat","allowExts","required","widthHeight"];return a.extend(d,c,{pluginInitializer:function(a){if(!a)return!1;var b=this,c=a.get("_oldInput");return c?(b.set("uploader",a),b.set("input",c),b.cover(),void 0):!1},cover:function(){var a=this;return a._setUploaderConfig(),a._setAuthConfig(),a},_setUploaderConfig:function(){var b,c=this,d=c.get("input"),e=c.get("uploader");a.each(f,function(c){if(b=d.attr(c)){switch(c){case"postData":c="data",b=a.JSON.parse(b);break;case"uploadType":c="type";break;case"autoUpload":b="true"==b}e.set(c,b)}})},_setAuthConfig:function(){var b=this,c=b.get("input"),d=b.get("uploader"),e=d.getPlugin("auth");if(!e)return!1;var f,h;a.each(g,function(a){if(f=c.attr(a)){switch(a){case"allowRepeat":f="true"==f;break;case"maxSize":f=Number(f)}e.set(a,f)}h=c.attr(a+"-msg"),h&&e.msg(a,h)})}},{ATTRS:{pluginId:{value:"tagConfig"},input:{value:e}}}),d},{requires:["node","base"]}),KISSY.add("gallery/uploader/1.5/plugins/urlsInput/urlsInput",function(a,b,c){function d(a){var b=this;d.superclass.constructor.call(b,a)}var e="",f=b.all,g="[uploader-urlsInput]:";return a.extend(d,c,{pluginInitializer:function(a){var b=this;if(!a)return!1;b.set("uploader",a),a.on("success",b._uploadSuccessHandler,b);var c=a.get("queue");c.on("remove",b._fileRemoveHandler,b)},_uploadSuccessHandler:function(b){var c=this,d=b.result;if(!a.isObject(d))return!1;var e=d.url;return c.get("useName")&&(e=d.name),c.add(e),c},_fileRemoveHandler:function(a){var b=this,c=a.file,d=c.result;if(!d)return!0;var e=d.url;b.get("useName")&&(e=d.name),b.remove(e)},add:function(b){if(!a.isString(b))return a.log(g+"add()\u7684url\u53c2\u6570\u4e0d\u5408\u6cd5\uff01"),!1;var c=this,d=c.get("urls"),f=c.isExist(b);return d[0]==e&&(d=[]),f?(a.log(g+"add()\uff0c\u6587\u4ef6\u8def\u5f84\u5df2\u7ecf\u5b58\u5728\uff01"),c):(d.push(b),c.set("urls",d),c._val(),c)},remove:function(b){if(!b)return!1;var c=this,d=c.get("urls"),e=c.isExist(b),f=new RegExp(b);return e?(d=a.filter(d,function(a){return!f.test(a)}),c.set("urls",d),c._val(),d):(a.log(g+"remove()\uff0c\u4e0d\u5b58\u5728\u8be5\u6587\u4ef6\u8def\u5f84\uff01"),!1)},parse:function(){var b=this,c=b.get("target");if(c){var d,h=f(c).val(),i=b.get("split");return h==e?[]:(d=h.split(i),b.set("urls",d),d)}return a.log(g+"cannot find urls input."),[]},_val:function(){var a=this,b=a.get("urls"),c=a.get("target"),d=a.get("split"),e=b.join(d);return c.val(e),e},isExist:function(b){var c=this,d=!1,e=c.get("urls"),f=new RegExp(b);return e.length?(a.each(e,function(a){return f.test(a)?d=!0:void 0}),d):!1}},{ATTRS:{pluginId:{value:"urlsInput"},uploader:{value:e},urls:{value:[]},split:{value:",",setter:function(a){var b=this;return b._val(),a}},target:{value:e,getter:function(a){return f(a)}},useName:{value:!1}}}),d},{requires:["node","base"]}),KISSY.add("gallery/uploader/1.5/plugins/paste/paste",function(a,b,c){function d(a){var b=this;d.superclass.constructor.call(b,a)}var e=b.all;return a.extend(d,c,{pluginInitializer:function(b){if(!b)return!1;var c=this,d=c.get("target");return d.length?(d.on("paste",function(c){var d=c.originalEvent&&c.originalEvent.clipboardData&&c.originalEvent.clipboardData.items;if(d&&d.length){var e=b.get("queue");a.each(d,function(c){var d=c.getAsFile&&c.getAsFile();if(a.isObject(d)){d.name="file-"+a.guid()+".png";var d={name:d.name,type:d.type,size:d.size,data:d};d=e.add(d);var f=e.getFileIndex(d.id);b.upload(f)}})}}),void 0):!1}},{ATTRS:{pluginId:{value:"paste"},target:{value:e(document)}}}),d},{requires:["node","base"]}),KISSY.add("gallery/uploader/1.5/plugins/miniLogin/miniLogin",function(a,b,c){function d(a){var b=this;d.superclass.constructor.call(b,a)}return b.all,a.extend(d,c,{pluginInitializer:function(a){return a?void 0:!1}},{ATTRS:{pluginId:{value:"miniLogin"}}}),d},{requires:["node","base","tbc/mini-login/1.4.0/"]}),KISSY.add("gallery/uploader/1.5/plugins/plugins",function(a,b,c,d,e,f,g,h,i,j,k){return{Auth:b,Filedrop:c,ImageZoom:d,Imgcrop:e,Preview:f,ProBars:g,TagConfig:h,UrlsInput:i,Paste:j,MiniLogin:k}},{requires:["./auth/auth","./filedrop/filedrop","./imageZoom/imageZoom","./imgcrop/imgcrop","./preview/preview","./proBars/proBars","./tagConfig/tagConfig","./urlsInput/urlsInput","./paste/paste","./miniLogin/miniLogin"]}),KISSY.add("gallery/uploader/1.5/aliUploader",function(a,b,c,d){function e(){var a=arguments[1]||location.hostname,b=a.split("."),c=b.length,d=arguments[0]||(3>c?0:1);return(d>=c||2>c-d)&&(d=c-2),b.slice(d).join(".")}function f(){var a=e(-1);return"net"==a}function g(){return f()&&m||n}function h(a){if(!a)return!1;var c=f()&&o||p;b.jsonp(c,function(b){var c=b.value;if(c){var b=a.get("data");b._tb_token_=c}})}function i(b){if(!b)return!1;var c=b.get("type");if("flash"!=c)return!1;var d,e,f,g=document.cookie.split(";"),h={};a.each(g,function(a){for(;" "===a.charAt(0);)a=a.substring(1,a.length);d=a.indexOf("="),d>0&&(e=a.substring(0,d),f=a.substring(d+1),h[e]=f)});var i=b.get("data");return a.mix(i,h),h}function j(b,c){var d=b.get("type"),f="iframe"==d;if(!f)return!1;c||(c=e(-2)),document.domain=c;var g=b.get("data");return g.domain=c,a.log("[AliUploader]\u8de8\u57df\u5f3a\u5236\u8bbe\u7f6edomain\uff1a"+c),g}function k(b){var c=!1;b.on("add",function(){if(!c){var d=b.getPlugin("urlsInput");d&&(d.set("useName",!0),c=!0,a.log("[UrlsInput]useName\u8bbe\u7f6e\u4e3atrue\uff1a\u4fdd\u5b58\u670d\u52a1\u5668\u7aef\u8fd4\u56de\u7684\u56fe\u7247\u540d"))}})}function l(a,b){b||(b={}),b.CORS=!0,b.action||(b.action=g()),b.data||(b.data={}),b.data._input_charset="utf-8";var d=new c(a,b);return i(d),j(d,b.domain),h(d),b.useName&&k(d),d}var m="http://aop.widgets.daily.taobao.net/json/uploadImg.htm",n="http://aop.widgets.taobao.com/json/uploadImg.htm",o="http://aop.widgets.daily.taobao.net/json/getReqParam.htm",p="http://aop.widgets.taobao.com/json/getReqParam.htm";return l.plugins=d,l.Uploader=c,l},{requires:["ajax","./index","./plugins/plugins"]});