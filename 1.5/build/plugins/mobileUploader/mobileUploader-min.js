/*!build time : 2013-11-13 5:44:02 PM*/
KISSY.add("gallery/uploader/1.5/plugins/mobileUploader/xmppUtil",function(){var a={begin:!1,localMap:{},init:function(){var a=this;1!=a.begin&&(a.begin=!0,KISSY.getScript("http://a.tbcdn.cn/p/xmpp/1.0/xmpp.js",function(){xmpp.register({ctype:"login",appId:"1063",subType:"1"},function(b){for(var c=0;c<b.length;c++){var d=b[c].t1;if("1063"==d){var e=b[c],f=e.content;"string"==typeof f&&(f=KISSY.JSON.parse(f));var g=f.subType,h=f.data,i=a.localMap[g],j=i.param,k=f.mtype;if(k&&"appCancle"==k)return i.hide(i),void 0;j.xmppcallback({data:h,bizMap:j})}}})}))},registerXmpp:function(a,b){this.localMap[a]=b}};return a}),KISSY.add("gallery/uploader/1.5/plugins/mobileUploader/qrcode",function(a,b,c){function d(c){var d={},e=c||{},f=e.bizMap;delete e.bizMap,a.mix(d,e),a.each(f,function(a,b){d["biz_"+b]=a}),d.subType||(d.subType="qrcode"+a.guid()),d.title&&(d.title=encodeURIComponent(d.title)),this.callback=c.callback,this.param=d,this.isRender=!1,this.isBind=!1;var g=this;6==b.ie&&(g.$mask4ie6=a.all('<iframe src="about:blank" style="display:none; left:-9999px; top:-9999px;" class="tb-qrcode-sb-mask-4-ie6" ></iframe>'),a.ready(function(){a.all("body").append(g.$mask4ie6)}))}var e=a.all;e(document);var f="http://m.service.taobao.com/getQrCode.htm",g="http://m.service.taobao.com/checkApp.htm",h="http://m.service.taobao.com/qrCodeApi.htm",i=".tb-qrcode-sb-mask-4-ie6{ border:none; position: absolute; left:0; top:0; width:1px; height:1px; background:red; filter: alpha(opacity=0); } .qrcode{font-family:simsun; position: absolute;}.qrcode .loading{width: 120px; height: 120px; background: url(http://img01.taobaocdn.com/tps/i1/T1cKm3XkRpXXXXXXXX-48-48.gif) center center no-repeat;border: 1px solid #eee;} .qrcode .qrcode-qr{background-color:#F7F7F7;border:1px solid #DDD; padding:10px;} .qrcode .qrcode-app{background-color: #f7f7f7;border: 1px solid #eee;padding: 25px 35px 21px 80px;width: 245px;background-image: url(http://gtms03.alicdn.com/tps/i3/T1LiuRFaFaXXcDFR2c-28-49.png);background-repeat: no-repeat;background-position: 25px 30px;}	.qrcode .app-title{color: #333;} .qrcode .app-body{color: #aaa;margin-top: 10px;} .qrcode .app-ft{text-align: right;margin-top: 15px;} .qrcode .app-ft a:hover{color: #ff6600;}	.qrcode .count-down, .qrcode .retry{display: inline-block; *display: inline;*zoom;width: 52px;margin-left: 12px;padding: 0 8px; line-height: 20px; cursor: pointer;text-align:center;background:#FCFCFC url(http://gtms04.alicdn.com/tps/i4/T1TgKSFiFbXXaJA2Ya-6-38.png) left top repeat-x; border: 1px solid #D0D0D0;} .retry:active{background-position:left bottom} .qrcode .count-down{padding: 0;border: 1px solid #d7d7d7;}	.qrcode .hd{padding:2px 0 10px;} .qrcode a{color:#36c;cursor:pointer;}.qrcode .bd,.qrcode .bd img{width:200px;height:200px;background:#fff;text-align:center;}.qrcode .ft{position:absolute;top:12px;right:11px;}.qrcode .ft a{display:inline-block;width:20px;height:21px;overflow:hidden;background-image:url(http://gtms02.alicdn.com/tps/i2/T12RORFmpXXXaeXpYa-20-42.png);}.qrcode .ft a:hover{background-position:0 -21px;}.qrcode .ft a span{visibility:hidden;}",j="%E6%AD%A3%E5%9C%A8%E8%8E%B7%E5%8F%96%E4%BA%8C%E7%BB%B4%E7%A0%81..",k="%E5%A6%82%E6%9E%9C%E6%89%8B%E6%9C%BA%E7%AB%AF%E5%B7%B2%E6%8F%90%E7%A4%BA%E4%B8%8A%E4%BC%A0%E6%88%90%E5%8A%9F%EF%BC%8C%3C%2Fbr%3E%E8%AF%B7",l="%E7%82%B9%E6%AD%A4%E9%A2%84%E8%A7%88",m="";m+='	<div class="qrcode">',m+='<div class="loading"></div>',m+="	</div>";var n='<div class="qrcode-qr"><div class="hd">\u63a8\u8350<a href="http://app.taobao.com/download/taoApps.htm?spm=a210u.1000832.297503.39.REFn4e&pageIndex=5" target="_blank">\u6dd8\u5b9d\u5ba2\u6237\u7aef</a>\u626b\u63cf</div>';n+='<div class="bd">',n+='<div><span class="J_qrimg">'+decodeURIComponent(j)+"</span></div>",n+="</div>",n+='<div class="ft">',n+='<a href="#" class="J_close"><span>\u5173\u95ed</span></a>',n+="</div>",n+='<div style="margin-top:6px; text-align:center">'+decodeURIComponent(k)+'<a class="J_preview">'+decodeURIComponent(l)+"</a></div>",n+="</div></div>";var o="%E5%B7%B2%E7%BB%8F%E5%90%91%E4%BD%A0%E7%9A%84%E6%89%8B%E6%9C%BA%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF%EF%BC%8C%E6%89%93%E5%BC%80%E6%B6%88%E6%81%AF%E5%8F%AF%E4%BB%A5%E7%9B%B4%E6%8E%A5%E7%94%A8%E6%89%8B%E6%9C%BA%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%EF%BC%81",p="%E8%8B%A5%E9%95%BF%E6%97%B6%E9%97%B4%E6%B2%A1%E6%94%B6%E5%88%B0%E6%B6%88%E6%81%AF%EF%BC%8C%E5%85%88%E6%89%8B%E5%8A%A8%E5%BC%80%E5%90%AF%E6%B7%98%E5%AE%9D%E5%AE%A2%E6%88%B7%E7%AB%AF%EF%BC%8C%E5%86%8D%E7%82%B9%E5%87%BB%E6%8C%89%E9%92%AE%E9%87%8D%E5%8F%91%E6%B6%88%E6%81%AF",q="%E6%94%BE%E5%BC%83%E4%BC%A0%E5%9B%BE",r='<div class="qrcode-app"><div class="app-title"><h3>'+decodeURIComponent(o)+"</h3></div>";r+='<div class="app-body"><span>'+decodeURIComponent(p)+'</span><span><span class="J_QrCountdown count-down" data-count="10"></span><button class="J_QrRetry retry" type="button" style="display: none;">\u91cd\u8bd5</button></span></div>',r+='<div class="app-ft"><span><a href="#" class="J_App_Cancle">'+decodeURIComponent(q)+"</a></span></div></div>";var s=c;return a.augment(d,a.EventTarget,{checkApp:function(){var b=this;b.param.daily&&(g="http://m.service.daily.taobao.net/checkApp.htm"),b.param._tt=(new Date).getTime(),a.IO({dataType:"jsonp",url:g,data:b.param,jsonpCallback:"CheckApp",success:function(a){var c=a;return b.param.qrid=c.qrid,b.param.mk=c.mk,b.param.t=c.t,c.appResult&&1==c.appResult?(b.container.html(r),b.countDown(b.container.one(".J_QrCountdown"),function(){b.container.one(".J_QrCountdown").hide(),b.container.one(".J_QrRetry").show()}),b.isCheckApp=!0,b.$mask4ie6&&b.$mask4ie6.css({width:362,height:173}),void 0):(b.container.html(n),b.getQR(),b.$mask4ie6&&b.$mask4ie6.css({width:222,height:294}),void 0)}})},countDown:function(a,b){var c=this,d=a.attr("data-count")||10,e=d;a.html(e+"\u79d2"),c.countdownInterval&&clearInterval(c.countdownInterval),c.countdownInterval=setInterval(function(){a.html(--e+"\u79d2"),"0"==e&&(clearInterval(c.countdownInterval),b())},1e3)},getQR:function(){var b=this;b.param.daily&&(f="http://m.service.daily.taobao.net/getQrCode.htm"),b.param._tt=(new Date).getTime(),a.IO({dataType:"jsonp",url:f,data:b.param,jsonpCallback:"QrCodeGetPic",success:function(a){var c=a,d=b.container.one(".J_qrimg"),e=document.createElement("img");e.onload=function(){d.html("").append(e)},e.src=c.picurl}})},render:function(){var b=this,c=e(m);a.DOM.addStyleSheet(i),e(document.body).append(c),b.container=c,b.isRender=!0,b.bindEvent(),b.xmpp()},bindEvent:function(){var c=this;c.param.daily&&(h="http://m.service.daily.taobao.net/qrCodeApi.htm"),c.container.delegate("click",".J_QrRetry",function(){c.param.api="retry",c.param._tt=(new Date).getTime(),a.IO({dataType:"jsonp",url:h,data:c.param,jsonpCallback:"QrCodeRetry",success:function(a){c.container.one(".J_QrCountdown").show(),c.countDown(c.container.one(".J_QrCountdown"),function(){c.container.one(".J_QrCountdown").hide(),c.container.one(".J_QrRetry").show()}),c.container.one(".J_QrRetry").hide()},error:function(){}})}),c.container.delegate("click",".J_App_Cancle",function(){c.param.daily&&(h="http://m.service.daily.taobao.net/qrCodeApi.htm"),c.param.api="cancle",c.param._tt=(new Date).getTime(),a.IO({dataType:"jsonp",url:h,data:c.param,jsonpCallback:"QrCodeCancle",success:function(a){c.container.hide(),6==b.ie&&c.$mask4ie6.hide()},error:function(){}})}),c.container.delegate("click",".J_close",function(a){a.halt(),c.container.hide(),c.$mask4ie6&&c.$mask4ie6.css({left:-9999,top:-9999}).hide()}),c.container.delegate("click",".J_preview",function(a){a.halt(),c.previewUploadResult(c.param)})},show:function(){var a=this;a.isRender||a.render(),a.container.html(m),a.checkApp(),a.container.show(),a.$mask4ie6&&setTimeout(function(){a.$mask4ie6.css({left:a.container.css("left"),top:a.container.css("top")}).show()})},hide:function(a){var b=a||this;b.$mask4ie6&&b.$mask4ie6.css({left:-9999,top:-9999}).hide(),b.container.hide(),b.countdownInterval&&clearInterval(b.countdownInterval)},xmpp:function(){var a=this;s.init(),s.registerXmpp(a.param.subType,a)},xmppcallback:function(){},previewUploadResult:function(b){var c=this;a.IO({dataType:"jsonp",url:"http://m.service.taobao.com/previewUploadResult.htm",jsonpCallback:"getPreviewResult",data:{qrid:b.qrid,mk:b.mk},success:function(a){1==a.success&&a.data&&c.param.xmppcallback(a.data)},error:function(){}})},offset:function(a,b){this.container.css({top:a,left:b})}}),d},{requires:["ua","./xmppUtil"]}),KISSY.add("gallery/uploader/1.5/plugins/mobileUploader/mobileUploader",function(a,b,c,d){function e(){var a=arguments[1]||location.hostname,b=a.split("."),c=b.length,d=arguments[0]||(3>c?0:1);return(d>=c||2>c-d)&&(d=c-2),b.slice(d).join(".")}function f(){var a=e(-1);return"net"==a}function g(a){var b=this;g.superclass.constructor.call(b,a),b.set("userConfig",a)}var h="",i=b.all,j="http://img01.daily.taobaocdn.net/consult/",k="http://img02.taobaocdn.com/consult/";return a.extend(g,c,{pluginInitializer:function(a){if(!a)return!1;var b=this;b.set("uploader",a);var c=b.get("target");return c.length?(c.on("click",b._clickHandler,b),void 0):!1},_clickHandler:function(){var a=this,b=a._renderQR();if(!b)return!0;var c=a.get("target"),d=c.offset();b.show(),b.offset(d.top,d.left+c.outerWidth()+10)},_renderQR:function(){var a=this,b=a.get("qr");if(b)return b;var c=a._config();return b=new d(c),a.set("qr",b),b},_config:function(){var b=this,c=b.get("uploader"),d=c.getPlugin("auth"),e=b.get("userConfig"),g=e;if(d){var h={max:d.get("max"),type:d.get("allowExts").replace(/,/g,"/")};g=a.merge(h,e)}return a.mix(g,{daily:f(),xmppcallback:function(a){b._xmppcallback(a.data)}}),g},_xmppcallback:function(b){var c=this;if(!a.isArray(b))return!1;a.log("mpp\u8fd4\u56de\u7684\u6587\u4ef6\u6570\u636e\u662f\uff1a"),a.log(ev.data);var d=c.get("qr");if(!d)return!1;d.hide();var e=c.get("uploader"),f=e.get("queue"),g=g(),h=g&&j||k;a.each(b,function(a){f.add({name:a.name,url:h+a.name})})}},{ATTRS:{pluginId:{value:"mobileUploader"},target:{value:h,getter:function(a){return i(a)}},uploader:{value:h},userConfig:{value:{}},qr:{value:h}}}),g},{requires:["node","base","./qrcode"]});