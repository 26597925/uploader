/*!build time : 2013-09-15 4:42:48 PM*/
KISSY.add("gallery/uploader/1.5/plugins/preview/preview",function(a,b,c,d,e){function f(){var b="";if("undefined"==typeof window.FileReader)switch(a.UA.shell){case"firefox":b="domfile";break;case"ie":switch(a.UA.ie){case 6:b="simple";break;default:b="filter"}}else b="html5";return b}function g(a,b){if(!a)return!1;if("filter"!=l)a.src=b||n;else if(b){b=b.replace(/[)'"%]/g,function(a){return escape(escape(a))});try{a.filters.item("DXImageTransform.Microsoft.AlphaImageLoader").src=b}catch(c){}}return!0}function h(b){var c=this,d={maxWidth:40,maxHeight:40};c.config=a.mix(d,b),h.superclass.constructor.call(c,b)}var i=b.all,j=document,k="[Plugin: Preview] ",l=f(),m={check:"check",success:"success",showed:"showed",error:"error"},n=a.UA.ie<8?"http://a.tbcdn.cn/p/fp/2011a/assets/space.gif":"data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==";return a.extend(h,e,{pluginInitializer:function(a){if(!a)return!1;var b=this;b.set("uploader",a),a.on("add",b._uploaderAddHandler,b)},_uploaderAddHandler:function(b){var c=this,d=c.get("uploader");if(d.get("hasRestore"))return!1;var e=d.get("fileInput"),f=b.file,g=f.data,h=f.id,j=c.get("preHook"),k=i(j+h);return k.length?(d.get("multiple")&&"ajax"==d.get("type")?c.show(g,k,function(){k.show()}):(c.preview(e,k),k.show()),void 0):(a.log("\u94a9\u5b50\u4e3a\uff1a"+j+h+"\uff0c\u627e\u4e0d\u5230\u56fe\u7247\u5143\u7d20\uff0c\u65e0\u6cd5\u9884\u89c8\u56fe\u7247"),!1)},show:function(b,c,d){if(!b||!c||!c.length)return!1;var e=this,f=new FileReader;f.onload=function(a){var b=e.data=a.target.result;e.fire(m.getData,{data:b,mode:l}),c.attr("src",b),d&&d.call(e,b),e.fire(m.showed,{img:b})},f.onerror=function(){a.log(k+"File Reader Error. Your browser may not fully support html5 file api","warning"),e.fire(m.error)},f.readAsDataURL(b)},preview:function(b,d){b=c.get(b),d=c.get(d);var e=this,f=function(){e.fire(m.getData,{data:e.data,mode:l}),d&&(g(d,e.data),e.fire(m.showed,{img:d}))};if(e.data=void 0,b){switch(a.log(k+"One file selected. Getting data..."),l){case"domfile":e.data=b.files[0].getAsDataURL();break;case"filter":b.select(),b.blur();try{e.data=j.selection.createRange().text}catch(h){a.log(k+"Get image data error, the error is: "),a.log(h,"dir")}finally{j.selection.empty()}e.data||(e.data=b.value);break;case"html5":var i=new FileReader;i.onload=function(a){e.data=a.target.result,f()},i.onerror=function(){a.log(k+"File Reader Error. Your browser may not fully support html5 file api","warning"),e.fire(m.error)},b.files&&i.readAsDataURL(b.files[0]);break;case"simple":default:e.data=b.value}e.data?f():"html5"!=l&&(a.log(k+"Retrive Data error."),g(d),e.fire(m.error))}else a.log(k+"File Input Element does not exists.");return e.data}},{ATTRS:{pluginId:{value:"preview"},uploader:{value:""},preHook:{value:".J_Pic_"}}}),h},{requires:["node","dom","event","base"]});